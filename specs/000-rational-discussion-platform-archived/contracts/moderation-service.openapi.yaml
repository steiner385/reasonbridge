openapi: 3.1.0
info:
  title: reasonBridge Moderation Service API
  description: Content moderation, user actions, and appeals management
  version: 1.0.0
  contact:
    name: reasonBridge Team

servers:
  - url: /api/v1/moderation
    description: Moderation service base path

tags:
  - name: Actions
    description: Moderation action operations
  - name: Appeals
    description: Appeal management
  - name: Queue
    description: Moderator review queue
  - name: Reports
    description: User content reports

paths:
  /actions:
    get:
      tags: [Actions]
      summary: List moderation actions
      description: For moderators to review action history
      operationId: listActions
      security:
        - bearerAuth: []
      parameters:
        - name: targetType
          in: query
          schema:
            type: string
            enum: [response, user, topic]
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, active, appealed, reversed]
        - name: severity
          in: query
          schema:
            type: string
            enum: [non_punitive, consequential]
        - $ref: '#/components/parameters/PageSize'
        - $ref: '#/components/parameters/PageCursor'
      responses:
        '200':
          description: List of moderation actions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationActionList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role

    post:
      tags: [Actions]
      summary: Create moderation action (moderator-initiated)
      operationId: createAction
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateActionRequest'
      responses:
        '201':
          description: Action created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationAction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role

  /actions/{actionId}:
    get:
      tags: [Actions]
      summary: Get moderation action details
      operationId: getAction
      security:
        - bearerAuth: []
      parameters:
        - name: actionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Action details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationActionDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /actions/{actionId}/approve:
    post:
      tags: [Actions]
      summary: Approve a pending consequential action
      description: Human-in-the-loop approval for hide/warn/remove actions (FR-026b)
      operationId: approveAction
      security:
        - bearerAuth: []
      parameters:
        - name: actionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                modifiedReasoning:
                  type: string
                  description: Optional updated reasoning
      responses:
        '200':
          description: Action approved and executed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationAction'
        '400':
          description: Action not in pending state or not consequential
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role
        '404':
          $ref: '#/components/responses/NotFound'

  /actions/{actionId}/reject:
    post:
      tags: [Actions]
      summary: Reject a pending action
      operationId: rejectAction
      security:
        - bearerAuth: []
      parameters:
        - name: actionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  description: Why the action was rejected
      responses:
        '200':
          description: Action rejected
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role
        '404':
          $ref: '#/components/responses/NotFound'

  /actions/ai-recommend:
    post:
      tags: [Actions]
      summary: Submit AI-recommended moderation action
      description: Called by AI service when content needs moderation review
      operationId: submitAiRecommendation
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiRecommendationRequest'
      responses:
        '201':
          description: Recommendation queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationAction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /appeals:
    get:
      tags: [Appeals]
      summary: List appeals
      operationId: listAppeals
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, under_review, upheld, denied]
        - $ref: '#/components/parameters/PageSize'
        - $ref: '#/components/parameters/PageCursor'
      responses:
        '200':
          description: List of appeals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppealList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role

    post:
      tags: [Appeals]
      summary: Submit an appeal
      description: User appeals a moderation action against their content
      operationId: submitAppeal
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitAppealRequest'
      responses:
        '201':
          description: Appeal submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Appeal'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Moderation action not found
        '409':
          description: Appeal already exists for this action

  /appeals/{appealId}:
    get:
      tags: [Appeals]
      summary: Get appeal details
      operationId: getAppeal
      security:
        - bearerAuth: []
      parameters:
        - name: appealId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Appeal details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppealDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /appeals/{appealId}/review:
    post:
      tags: [Appeals]
      summary: Review and decide on an appeal
      operationId: reviewAppeal
      security:
        - bearerAuth: []
      parameters:
        - name: appealId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewAppealRequest'
      responses:
        '200':
          description: Appeal decision recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Appeal'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role
        '404':
          $ref: '#/components/responses/NotFound'

  /queue:
    get:
      tags: [Queue]
      summary: Get moderator review queue
      description: Returns items requiring human review
      operationId: getQueue
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [actions, appeals, reports]
        - name: priority
          in: query
          schema:
            type: string
            enum: [high, normal, low]
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Queue items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role

  /queue/stats:
    get:
      tags: [Queue]
      summary: Get queue statistics
      operationId: getQueueStats
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Queue statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStats'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Requires moderator role

  /reports:
    post:
      tags: [Reports]
      summary: Report content
      description: User reports content for moderation review
      operationId: submitReport
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitReportRequest'
      responses:
        '201':
          description: Report submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          description: Too many reports (rate limited)

  /reports/{reportId}:
    get:
      tags: [Reports]
      summary: Get report status
      description: Reporter can check status of their report
      operationId: getReport
      security:
        - bearerAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Report details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Can only view own reports
        '404':
          $ref: '#/components/responses/NotFound'

  /interventions/cooling-off:
    post:
      tags: [Actions]
      summary: Send cooling-off prompt
      description: Non-punitive intervention for escalating discussions (autonomous)
      operationId: sendCoolingOffPrompt
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userIds, topicId, prompt]
              properties:
                userIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                topicId:
                  type: string
                  format: uuid
                prompt:
                  type: string
                  description: Cooling-off message (reappraisal-based per FR-026)
      responses:
        '200':
          description: Prompts sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  sent:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/{userId}/actions:
    get:
      tags: [Actions]
      summary: Get moderation history for a user
      operationId: getUserActions
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User's moderation history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationActionList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Can only view own history or requires moderator role

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    serviceAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Service-to-service authentication

  parameters:
    PageSize:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    PageCursor:
      name: cursor
      in: query
      schema:
        type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    ModerationAction:
      type: object
      required: [id, targetType, targetId, actionType, severity, reasoning, status]
      properties:
        id:
          type: string
          format: uuid
        targetType:
          type: string
          enum: [response, user, topic]
        targetId:
          type: string
          format: uuid
        actionType:
          type: string
          enum: [educate, warn, hide, remove, suspend, ban]
        severity:
          type: string
          enum: [non_punitive, consequential]
        reasoning:
          type: string
          description: Transparent explanation (FR-024)
        aiRecommended:
          type: boolean
        aiConfidence:
          type: number
        approvedBy:
          $ref: '#/components/schemas/UserSummary'
        approvedAt:
          type: string
          format: date-time
        status:
          type: string
          enum: [pending, active, appealed, reversed]
        createdAt:
          type: string
          format: date-time
        executedAt:
          type: string
          format: date-time

    ModerationActionDetail:
      allOf:
        - $ref: '#/components/schemas/ModerationAction'
        - type: object
          properties:
            targetContent:
              type: object
              description: The content that was moderated
            appeal:
              $ref: '#/components/schemas/Appeal'
            relatedActions:
              type: array
              items:
                $ref: '#/components/schemas/ModerationAction'

    ModerationActionList:
      type: object
      properties:
        actions:
          type: array
          items:
            $ref: '#/components/schemas/ModerationAction'
        nextCursor:
          type: string
        totalCount:
          type: integer

    CreateActionRequest:
      type: object
      required: [targetType, targetId, actionType, reasoning]
      properties:
        targetType:
          type: string
          enum: [response, user, topic]
        targetId:
          type: string
          format: uuid
        actionType:
          type: string
          enum: [educate, warn, hide, remove, suspend, ban]
        reasoning:
          type: string
          minLength: 20

    AiRecommendationRequest:
      type: object
      required: [targetType, targetId, actionType, reasoning, confidence]
      properties:
        targetType:
          type: string
          enum: [response, user, topic]
        targetId:
          type: string
          format: uuid
        actionType:
          type: string
          enum: [educate, warn, hide, remove, suspend, ban]
        reasoning:
          type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
        analysisDetails:
          type: object
          description: Supporting data from AI analysis

    Appeal:
      type: object
      required: [id, moderationActionId, appellantId, reason, status]
      properties:
        id:
          type: string
          format: uuid
        moderationActionId:
          type: string
          format: uuid
        appellant:
          $ref: '#/components/schemas/UserSummary'
        reason:
          type: string
        status:
          type: string
          enum: [pending, under_review, upheld, denied]
        reviewer:
          $ref: '#/components/schemas/UserSummary'
        decisionReasoning:
          type: string
        createdAt:
          type: string
          format: date-time
        resolvedAt:
          type: string
          format: date-time

    AppealDetail:
      allOf:
        - $ref: '#/components/schemas/Appeal'
        - type: object
          properties:
            moderationAction:
              $ref: '#/components/schemas/ModerationActionDetail'

    AppealList:
      type: object
      properties:
        appeals:
          type: array
          items:
            $ref: '#/components/schemas/Appeal'
        nextCursor:
          type: string
        totalCount:
          type: integer

    SubmitAppealRequest:
      type: object
      required: [moderationActionId, reason]
      properties:
        moderationActionId:
          type: string
          format: uuid
        reason:
          type: string
          minLength: 20
          maxLength: 2000

    ReviewAppealRequest:
      type: object
      required: [decision, reasoning]
      properties:
        decision:
          type: string
          enum: [upheld, denied]
          description: upheld = action reversed, denied = action stands
        reasoning:
          type: string
          minLength: 20

    Report:
      type: object
      required: [id, targetType, targetId, reason, status]
      properties:
        id:
          type: string
          format: uuid
        targetType:
          type: string
          enum: [response, user, topic]
        targetId:
          type: string
          format: uuid
        reason:
          type: string
          enum: [spam, harassment, misinformation, bot_suspected, off_topic, other]
        details:
          type: string
        status:
          type: string
          enum: [pending, reviewed, action_taken, dismissed]
        resultingActionId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        resolvedAt:
          type: string
          format: date-time

    SubmitReportRequest:
      type: object
      required: [targetType, targetId, reason]
      properties:
        targetType:
          type: string
          enum: [response, user, topic]
        targetId:
          type: string
          format: uuid
        reason:
          type: string
          enum: [spam, harassment, misinformation, bot_suspected, off_topic, other]
        details:
          type: string
          maxLength: 1000

    QueueResponse:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [action, appeal, report]
              id:
                type: string
                format: uuid
              priority:
                type: string
                enum: [high, normal, low]
              waitTime:
                type: string
                description: Time in queue (ISO 8601 duration)
              summary:
                type: string
        totalCount:
          type: integer

    QueueStats:
      type: object
      properties:
        pendingActions:
          type: integer
        pendingAppeals:
          type: integer
        pendingReports:
          type: integer
        avgResolutionTimeMinutes:
          type: number
        oldestItemAge:
          type: string
          description: ISO 8601 duration

    UserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        displayName:
          type: string

    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
