openapi: 3.1.0
info:
  title: reasonBridge AI Service API
  description: AI-powered feedback, analysis, and content evaluation
  version: 1.0.0
  contact:
    name: reasonBridge Team

servers:
  - url: /api/v1/ai
    description: AI service base path

tags:
  - name: Feedback
    description: Real-time composition feedback
  - name: Analysis
    description: AI analysis operations
  - name: Suggestions
    description: AI-generated suggestions

paths:
  /analyze/response:
    post:
      tags: [Feedback]
      summary: Analyze response content in real-time
      description: |
        Analyzes response content for cognitive biases, logical fallacies,
        inflammatory language, and unsourced claims. Returns feedback only
        when confidence >= 80% (FR-014c).
      operationId: analyzeResponse
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalyzeResponseRequest'
      responses:
        '200':
          description: Analysis results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResponseAnalysis'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /analyze/claims:
    post:
      tags: [Feedback]
      summary: Extract and analyze factual claims
      description: Identifies checkable factual claims in content for fact-check retrieval
      operationId: analyzeClaims
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  maxLength: 10000
      responses:
        '200':
          description: Extracted claims
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimAnalysis'
        '400':
          $ref: '#/components/responses/BadRequest'

  /generate/common-ground:
    post:
      tags: [Analysis]
      summary: Generate common ground analysis
      description: |
        Triggers common ground analysis for a topic using Bedrock LLM.
        This is typically called by the discussion-service when thresholds are met.
      operationId: generateCommonGroundAnalysis
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateCommonGroundRequest'
      responses:
        '202':
          description: Analysis generation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysisId:
                    type: string
                    format: uuid
                  estimatedCompletionMs:
                    type: integer
                    description: Estimated time in milliseconds (<5000)
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /generate/common-ground/{analysisId}:
    get:
      tags: [Analysis]
      summary: Get common ground analysis status/result
      operationId: getCommonGroundAnalysisStatus
      security:
        - serviceAuth: []
      parameters:
        - name: analysisId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Analysis result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommonGroundResult'
        '202':
          description: Analysis still in progress
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [processing]
                  progress:
                    type: number
                    minimum: 0
                    maximum: 1
        '404':
          $ref: '#/components/responses/NotFound'

  /generate/moral-foundations:
    post:
      tags: [Analysis]
      summary: Analyze moral foundations in arguments
      description: |
        Identifies which moral foundations (Haidt) underlie given arguments.
        Used for user profile inference and disagreement analysis.
      operationId: analyzeMoralFoundations
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MoralFoundationsRequest'
      responses:
        '200':
          description: Moral foundations analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MoralFoundationsResult'
        '400':
          $ref: '#/components/responses/BadRequest'

  /generate/translation:
    post:
      tags: [Suggestions]
      summary: Generate argument translation
      description: |
        Translates an argument to appeal to different moral foundations.
        Helps users reframe arguments for cross-perspective communication (FR-017a).
      operationId: generateArgumentTranslation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranslationRequest'
      responses:
        '200':
          description: Translated argument suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslationResult'
        '400':
          $ref: '#/components/responses/BadRequest'

  /suggest/tags:
    post:
      tags: [Suggestions]
      summary: Suggest tags for topic content
      operationId: suggestTags
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, description]
              properties:
                title:
                  type: string
                description:
                  type: string
                existingTags:
                  type: array
                  items:
                    type: string
                  description: Already assigned tags to avoid duplicates
      responses:
        '200':
          description: Tag suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggestions:
                    type: array
                    items:
                      type: object
                      properties:
                        tagId:
                          type: string
                          format: uuid
                        tagName:
                          type: string
                        confidence:
                          type: number

  /suggest/topic-links:
    post:
      tags: [Suggestions]
      summary: Suggest related topics
      operationId: suggestTopicLinks
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [topicId]
              properties:
                topicId:
                  type: string
                  format: uuid
                topicContent:
                  type: string
                  description: Topic title + description for semantic analysis
      responses:
        '200':
          description: Related topic suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggestions:
                    type: array
                    items:
                      type: object
                      properties:
                        targetTopicId:
                          type: string
                          format: uuid
                        relationshipType:
                          type: string
                          enum: [builds_on, responds_to, contradicts, related, shares_proposition]
                        confidence:
                          type: number
                        reasoning:
                          type: string

  /suggest/propositions:
    post:
      tags: [Suggestions]
      summary: Extract propositions from response
      description: AI identifies distinct claims/positions in a response (FR-008a)
      operationId: suggestPropositions
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [responseContent, topicId]
              properties:
                responseContent:
                  type: string
                topicId:
                  type: string
                  format: uuid
                existingPropositions:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      statement:
                        type: string
      responses:
        '200':
          description: Proposition suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  extractedPropositions:
                    type: array
                    items:
                      type: object
                      properties:
                        statement:
                          type: string
                        confidence:
                          type: number
                        isNew:
                          type: boolean
                          description: Not matched to existing proposition
                        matchedPropositionId:
                          type: string
                          format: uuid
                          description: If matched to existing
                        relevanceScore:
                          type: number

  /feedback/{feedbackId}/rating:
    post:
      tags: [Feedback]
      summary: Rate feedback helpfulness
      operationId: rateFeedback
      security:
        - bearerAuth: []
      parameters:
        - name: feedbackId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rating]
              properties:
                rating:
                  type: string
                  enum: [helpful, not_helpful]
      responses:
        '200':
          description: Rating recorded
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /detect/escalation:
    post:
      tags: [Analysis]
      summary: Detect tone escalation in discussion
      description: |
        Analyzes recent responses for escalating tone patterns.
        Used by moderation service to trigger cooling-off interventions (FR-026).
      operationId: detectEscalation
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [responses]
              properties:
                responses:
                  type: array
                  items:
                    type: object
                    properties:
                      responseId:
                        type: string
                        format: uuid
                      content:
                        type: string
                      authorId:
                        type: string
                        format: uuid
                      timestamp:
                        type: string
                        format: date-time
      responses:
        '200':
          description: Escalation detection result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EscalationResult'

  /generate/reappraisal:
    post:
      tags: [Suggestions]
      summary: Generate cognitive reappraisal prompt
      description: |
        Creates a reappraisal scaffold based on Gross's Process Model (FR-026a).
        Helps users reinterpret triggering content before responding.
      operationId: generateReappraisal
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [triggeringContent, userResponseDraft]
              properties:
                triggeringContent:
                  type: string
                  description: Content the user is reacting to
                userResponseDraft:
                  type: string
                  description: User's draft response showing emotional reaction
      responses:
        '200':
          description: Reappraisal prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReappraisalPrompt'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: User authentication
    serviceAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Service-to-service authentication

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    AnalyzeResponseRequest:
      type: object
      required: [content]
      properties:
        content:
          type: string
          maxLength: 10000
        topicId:
          type: string
          format: uuid
          description: Context for topic-specific analysis
        isRevision:
          type: boolean
          default: false
          description: Whether this is a revision after feedback

    ResponseAnalysis:
      type: object
      properties:
        feedback:
          type: array
          items:
            $ref: '#/components/schemas/FeedbackItem'
          description: Only items with confidence >= 80%
        overallTone:
          type: string
          enum: [constructive, neutral, inflammatory]
        containsFactualClaims:
          type: boolean
        suggestedRevisions:
          type: array
          items:
            type: object
            properties:
              originalText:
                type: string
              suggestedText:
                type: string
              reason:
                type: string

    FeedbackItem:
      type: object
      required: [id, type, suggestionText, reasoning, confidence]
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [fallacy, inflammatory, unsourced, bias, affirmation]
        subtype:
          type: string
          description: Specific fallacy name, bias type, etc.
        suggestionText:
          type: string
          description: User-facing feedback in "curious peer" voice
        reasoning:
          type: string
          description: AI explanation for transparency
        confidence:
          type: number
          minimum: 0.8
          maximum: 1
          description: Only returned if >= 0.80
        highlightRange:
          type: object
          properties:
            start:
              type: integer
            end:
              type: integer
        educationalResources:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              url:
                type: string
                format: uri

    ClaimAnalysis:
      type: object
      properties:
        claims:
          type: array
          items:
            type: object
            properties:
              text:
                type: string
              startOffset:
                type: integer
              endOffset:
                type: integer
              isCheckable:
                type: boolean
              suggestSource:
                type: boolean
                description: Should prompt user to add source

    GenerateCommonGroundRequest:
      type: object
      required: [topicId, propositions, responses]
      properties:
        topicId:
          type: string
          format: uuid
        propositions:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              statement:
                type: string
              supportCount:
                type: integer
              opposeCount:
                type: integer
              nuancedCount:
                type: integer
        responses:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              content:
                type: string
              authorId:
                type: string
                format: uuid
              propositionAlignments:
                type: array
                items:
                  type: object
                  properties:
                    propositionId:
                      type: string
                      format: uuid
                    stance:
                      type: string
                      enum: [support, oppose, nuanced]

    CommonGroundResult:
      type: object
      properties:
        status:
          type: string
          enum: [completed, failed]
        agreementZones:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              confidence:
                type: number
              propositionIds:
                type: array
                items:
                  type: string
                  format: uuid
              participantPercentage:
                type: number
        misunderstandings:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              term:
                type: string
              definitions:
                type: array
                items:
                  type: object
                  properties:
                    definition:
                      type: string
                    userIds:
                      type: array
                      items:
                        type: string
                        format: uuid
        genuineDisagreements:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              underlyingValues:
                type: array
                items:
                  type: string
              moralFoundations:
                type: array
                items:
                  type: string
                  enum: [care, fairness, loyalty, authority, sanctity, liberty]
              propositionIds:
                type: array
                items:
                  type: string
                  format: uuid
        overallConsensusScore:
          type: number
          minimum: 0
          maximum: 1
        modelVersion:
          type: string

    MoralFoundationsRequest:
      type: object
      required: [arguments]
      properties:
        arguments:
          type: array
          items:
            type: object
            properties:
              text:
                type: string
              authorId:
                type: string
                format: uuid

    MoralFoundationsResult:
      type: object
      properties:
        argumentAnalyses:
          type: array
          items:
            type: object
            properties:
              authorId:
                type: string
                format: uuid
              foundations:
                type: object
                properties:
                  care:
                    type: number
                  fairness:
                    type: number
                  loyalty:
                    type: number
                  authority:
                    type: number
                  sanctity:
                    type: number
                  liberty:
                    type: number
              confidence:
                type: number

    TranslationRequest:
      type: object
      required: [argument, targetFoundations]
      properties:
        argument:
          type: string
          description: Original argument to translate
        sourceFoundations:
          type: array
          items:
            type: string
            enum: [care, fairness, loyalty, authority, sanctity, liberty]
          description: Detected foundations in original (optional)
        targetFoundations:
          type: array
          items:
            type: string
            enum: [care, fairness, loyalty, authority, sanctity, liberty]
          description: Foundations to appeal to in translation

    TranslationResult:
      type: object
      properties:
        translations:
          type: array
          items:
            type: object
            properties:
              translatedArgument:
                type: string
              targetFoundation:
                type: string
              explanation:
                type: string
                description: How the reframing appeals to the target foundation

    EscalationResult:
      type: object
      properties:
        isEscalating:
          type: boolean
        escalationLevel:
          type: string
          enum: [none, mild, moderate, severe]
        confidence:
          type: number
        triggeringResponses:
          type: array
          items:
            type: string
            format: uuid
        suggestedIntervention:
          type: string
          enum: [none, cooling_off, reappraisal, moderator_review]

    ReappraisalPrompt:
      type: object
      properties:
        prompt:
          type: string
          description: Reappraisal question in "curious peer" voice
        alternativeInterpretations:
          type: array
          items:
            type: string
          description: Ways the triggering content might be interpreted differently
        coolingOffSuggestion:
          type: boolean
          description: Whether to suggest a brief pause

    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
