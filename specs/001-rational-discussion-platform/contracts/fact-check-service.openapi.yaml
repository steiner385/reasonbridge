openapi: 3.1.0
info:
  title: uniteDiscord Fact-Check Service API
  description: External fact-check API integration and claim verification
  version: 1.0.0
  contact:
    name: uniteDiscord Team

servers:
  - url: /api/v1/fact-check
    description: Fact-check service base path

tags:
  - name: Claims
    description: Claim verification operations
  - name: Sources
    description: Source credibility operations

paths:
  /check:
    post:
      tags: [Claims]
      summary: Check factual claims
      description: |
        Retrieves fact-check information for given claims from external databases.
        Results are presented as "Related Context" without rendering verdicts (FR-012b).
      operationId: checkClaims
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckClaimsRequest'
      responses:
        '200':
          description: Fact-check results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckClaimsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /results/{responseId}:
    get:
      tags: [Claims]
      summary: Get fact-check results for a response
      operationId: getResultsForResponse
      parameters:
        - name: responseId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Cached fact-check results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/FactCheckResult'
        '404':
          description: No results found or expired

  /sources/{domain}:
    get:
      tags: [Sources]
      summary: Get source credibility rating
      operationId: getSourceCredibility
      parameters:
        - name: domain
          in: path
          required: true
          schema:
            type: string
          description: Domain to check (e.g., "example.com")
      responses:
        '200':
          description: Source credibility information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceCredibility'
        '404':
          description: No credibility data available

  /sources/batch:
    post:
      tags: [Sources]
      summary: Get credibility for multiple sources
      operationId: batchSourceCredibility
      security:
        - serviceAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [domains]
              properties:
                domains:
                  type: array
                  items:
                    type: string
                  maxItems: 50
      responses:
        '200':
          description: Source credibility results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/SourceCredibility'

  /providers:
    get:
      tags: [Claims]
      summary: List available fact-check providers
      operationId: listProviders
      responses:
        '200':
          description: List of fact-check providers
          content:
            application/json:
              schema:
                type: object
                properties:
                  providers:
                    type: array
                    items:
                      $ref: '#/components/schemas/FactCheckProvider'

components:
  securitySchemes:
    serviceAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Service-to-service authentication

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    CheckClaimsRequest:
      type: object
      required: [responseId, claims]
      properties:
        responseId:
          type: string
          format: uuid
          description: Response containing the claims
        claims:
          type: array
          items:
            type: object
            required: [text, startOffset, endOffset]
            properties:
              text:
                type: string
                description: The factual claim to check
              startOffset:
                type: integer
                description: Position in original response
              endOffset:
                type: integer

    CheckClaimsResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/FactCheckResult'
        processingTimeMs:
          type: integer

    FactCheckResult:
      type: object
      required: [id, claimText, displayedAs, sources]
      properties:
        id:
          type: string
          format: uuid
        claimText:
          type: string
        claimStartOffset:
          type: integer
        claimEndOffset:
          type: integer
        displayedAs:
          type: string
          default: Related Context
          description: UI label - never "verdict" or "truth rating"
        sources:
          type: array
          items:
            $ref: '#/components/schemas/FactCheckSource'
        hasConflictingSources:
          type: boolean
          description: True if sources disagree
        conflictSummary:
          type: string
          description: Explanation of conflict if sources disagree
        expiresAt:
          type: string
          format: date-time
          description: Cache expiration (24h default)

    FactCheckSource:
      type: object
      required: [provider, url, title]
      properties:
        provider:
          type: string
          description: Fact-check provider name (e.g., "Snopes", "PolitiFact")
        url:
          type: string
          format: uri
        title:
          type: string
        publishedAt:
          type: string
          format: date-time
        rating:
          type: string
          description: Provider's rating (passed through, not interpreted)
        ratingDescription:
          type: string
          description: Full description from provider
        credibilityScore:
          type: number
          minimum: 0
          maximum: 1
          description: Source credibility rating
        retrievedAt:
          type: string
          format: date-time

    SourceCredibility:
      type: object
      properties:
        domain:
          type: string
        overallScore:
          type: number
          minimum: 0
          maximum: 1
        factualReporting:
          type: string
          enum: [very_high, high, mixed, low, very_low, unknown]
        biasRating:
          type: string
          enum: [left, left_center, center, right_center, right, unknown]
        mediaType:
          type: string
          enum: [news, opinion, satire, advocacy, academic, government, unknown]
        sources:
          type: array
          items:
            type: object
            properties:
              rater:
                type: string
                description: Who provided the rating
              rating:
                type: string
              url:
                type: string
                format: uri
        lastUpdated:
          type: string
          format: date-time

    FactCheckProvider:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        url:
          type: string
          format: uri
        topics:
          type: array
          items:
            type: string
          description: Topics this provider covers
        isActive:
          type: boolean

    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
