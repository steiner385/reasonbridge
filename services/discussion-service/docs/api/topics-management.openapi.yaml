openapi: 3.0.3
info:
  title: Topic Management API
  description: |
    Feature 016: Topic Management API documentation

    Comprehensive topic management endpoints for creating, discovering, editing,
    managing status, viewing analytics, and merging topics.
  version: 1.0.0
  contact:
    name: ReasonBridge API Team

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://api.reasonbridge.org
    description: Production

tags:
  - name: Topics
    description: Topic CRUD operations
  - name: Status Management
    description: Topic status and visibility control
  - name: Editing
    description: Topic editing and history
  - name: Analytics
    description: Topic participation and engagement metrics
  - name: Merging
    description: Topic merging (moderator-only)

paths:
  /topics:
    get:
      summary: Get topics with filtering and search
      description: |
        Retrieve paginated list of topics with optional filtering by status,
        visibility, tags, and full-text search. Results are cached for 5 minutes.
      tags:
        - Topics
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [SEEDING, ACTIVE, ARCHIVED, LOCKED]
        - name: visibility
          in: query
          schema:
            type: string
            enum: [PUBLIC, PRIVATE, UNLISTED]
        - name: search
          in: query
          schema:
            type: string
          description: Full-text search query
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
          description: Filter by tags (AND logic)
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [createdAt, lastActivityAt, responseCount]
            default: createdAt
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTopicsResponse'

    post:
      summary: Create a new topic
      description: |
        Create a new discussion topic. Requires authentication.
        Rate limited to 5 requests per day per user.
        Topics start in SEEDING status.
      tags:
        - Topics
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTopicDto'
      responses:
        '201':
          description: Topic created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicResponse'
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '429':
          description: Rate limit exceeded (5 per day)

  /topics/{id}:
    get:
      summary: Get topic by ID
      tags:
        - Topics
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicResponse'
        '404':
          description: Topic not found

    patch:
      summary: Update topic details
      description: |
        Edit topic title, description, or tags. Requires authentication and
        ownership (or moderator role). Edit reason required for topics >24 hours old.
      tags:
        - Editing
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTopicDto'
      responses:
        '200':
          description: Topic updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicResponse'
        '400':
          description: Validation error or permission denied
        '401':
          description: Unauthorized
        '404':
          description: Topic not found

  /topics/{id}/status:
    patch:
      summary: Update topic status
      description: |
        Change topic status (SEEDING→ACTIVE, ACTIVE→ARCHIVED/LOCKED, etc.).
        Requires authentication and ownership (or moderator role).
        Only moderators can lock/unlock topics.
      tags:
        - Status Management
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTopicStatusDto'
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicResponse'
        '400':
          description: Invalid status transition or permission denied
        '401':
          description: Unauthorized
        '404':
          description: Topic not found

  /topics/{id}/history:
    get:
      summary: Get topic edit history
      description: |
        Retrieve chronological list of all edits made to a topic.
        Shows old/new values for title, description, tags, and edit reasons.
      tags:
        - Editing
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicEditHistoryResponse'
        '404':
          description: Topic not found

  /topics/{id}/analytics:
    get:
      summary: Get topic analytics
      description: |
        Retrieve participation metrics, engagement trends, and activity over time.
        Combines real-time data for today with historical aggregates.
      tags:
        - Analytics
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: days
          in: query
          schema:
            type: integer
            minimum: 7
            maximum: 365
            default: 30
          description: Number of days of historical data to retrieve
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicAnalyticsResponse'
        '404':
          description: Topic not found

  /topics/merge:
    post:
      summary: Merge multiple topics into one
      description: |
        Moderator-only operation to consolidate duplicate or related topics.
        Moves all responses from source topics to target, archives sources.
        Creates merge record with 30-day rollback window.
      tags:
        - Merging
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeTopicsDto'
      responses:
        '200':
          description: Topics merged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicResponse'
        '400':
          description: Validation error or invalid merge operation
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (moderator role required)
        '404':
          description: One or more topics not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    PaginatedTopicsResponse:
      type: object
      properties:
        topics:
          type: array
          items:
            $ref: '#/components/schemas/TopicResponse'
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
        totalPages:
          type: integer

    TopicResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          minLength: 10
          maxLength: 200
        description:
          type: string
        creatorId:
          type: string
          format: uuid
        status:
          type: string
          enum: [SEEDING, ACTIVE, ARCHIVED, LOCKED]
        visibility:
          type: string
          enum: [PUBLIC, PRIVATE, UNLISTED]
        slug:
          type: string
        evidenceStandards:
          type: string
        minimumDiversityScore:
          type: number
        currentDiversityScore:
          type: number
          nullable: true
        participantCount:
          type: integer
        responseCount:
          type: integer
        crossCuttingThemes:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        activatedAt:
          type: string
          format: date-time
          nullable: true
        archivedAt:
          type: string
          format: date-time
          nullable: true
        tags:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              name:
                type: string

    CreateTopicDto:
      type: object
      required:
        - title
        - description
        - tags
      properties:
        title:
          type: string
          minLength: 10
          maxLength: 200
        description:
          type: string
          minLength: 50
          maxLength: 5000
        tags:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 5

    UpdateTopicDto:
      type: object
      properties:
        title:
          type: string
          minLength: 10
          maxLength: 200
        description:
          type: string
          minLength: 50
          maxLength: 5000
        tags:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 5
        editReason:
          type: string
          minLength: 10
          maxLength: 500
          description: Required for topics older than 24 hours
        flagForReview:
          type: boolean
          description: Flag this edit for moderator review

    UpdateTopicStatusDto:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [SEEDING, ACTIVE, ARCHIVED, LOCKED]

    MergeTopicsDto:
      type: object
      required:
        - sourceTopicIds
        - targetTopicId
        - mergeReason
      properties:
        sourceTopicIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          description: Topics to merge (will be archived)
        targetTopicId:
          type: string
          format: uuid
          description: Target topic that receives all content
        mergeReason:
          type: string
          minLength: 20
          maxLength: 1000

    TopicEditHistoryResponse:
      type: object
      properties:
        edits:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              topicId:
                type: string
                format: uuid
              editorId:
                type: string
                format: uuid
              editedAt:
                type: string
                format: date-time
              previousTitle:
                type: string
                nullable: true
              newTitle:
                type: string
                nullable: true
              previousDescription:
                type: string
                nullable: true
              newDescription:
                type: string
                nullable: true
              previousTags:
                type: array
                items:
                  type: string
              newTags:
                type: array
                items:
                  type: string
              changeReason:
                type: string
                nullable: true
              flaggedForReview:
                type: boolean
              editor:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  username:
                    type: string
        total:
          type: integer

    TopicAnalyticsResponse:
      type: object
      properties:
        topicId:
          type: string
          format: uuid
        summary:
          type: object
          properties:
            totalViews:
              type: integer
            totalResponses:
              type: integer
            totalParticipants:
              type: integer
            avgEngagementScore:
              type: number
            createdAt:
              type: string
              format: date-time
            lastActivityAt:
              type: string
              format: date-time
        dailyMetrics:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              viewCount:
                type: integer
              uniqueViewers:
                type: integer
              responseCount:
                type: integer
              participantCount:
                type: integer
              newParticipants:
                type: integer
              avgResponseLength:
                type: integer
              engagementScore:
                type: number
              peakActivityHour:
                type: integer
                minimum: 0
                maximum: 23
                nullable: true
        trends:
          type: object
          properties:
            viewsGrowth:
              type: number
              description: Percentage growth from previous period
            responsesGrowth:
              type: number
            participantsGrowth:
              type: number
            engagementTrend:
              type: string
              enum: [increasing, stable, decreasing]
