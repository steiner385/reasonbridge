#!/bin/bash

# ============================================================================
# Pre-Commit Hook: Dependency Security Audit
# ============================================================================
# Scans dependencies for known security vulnerabilities
# Blocks commits only for high/critical vulnerabilities in production deps
#
# Usage: Called automatically by git pre-commit hook
# Can be tested standalone: bash .husky/pre-commit-dependencies-audit
# ============================================================================

set -e

# Source color utilities
source "$(dirname -- "$0")/colors.sh"

echo ""
echo "ðŸ”’ Running dependency security audit..."

# ============================================================================
# Run audit based on package manager
# ============================================================================

# Create temp file for audit results
AUDIT_TEMP="/tmp/dependency-audit-$$.json"

# Detect package manager and run appropriate audit
if [ -f "pnpm-lock.yaml" ]; then
  # Use pnpm audit for pnpm projects
  # Only check production dependencies (--prod)
  pnpm audit --json --prod 2>/dev/null > "$AUDIT_TEMP" || true

  # pnpm audit JSON structure: { "advisories": { "id": { "severity": "..." } } }
  # Count high and critical vulnerabilities
  CRITICAL=$(jq '[.advisories | to_entries[] | select(.value.severity == "critical")] | length' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  HIGH=$(jq '[.advisories | to_entries[] | select(.value.severity == "high")] | length' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  MODERATE=$(jq '[.advisories | to_entries[] | select(.value.severity == "moderate")] | length' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  LOW=$(jq '[.advisories | to_entries[] | select(.value.severity == "low")] | length' "$AUDIT_TEMP" 2>/dev/null || echo "0")

  VULNERABILITIES=$((CRITICAL + HIGH + MODERATE + LOW))
  BLOCKING_VULNS=$((CRITICAL + HIGH))

  PKG_MANAGER="pnpm"
else
  # Run npm audit for npm projects
  npm audit --json --production 2>/dev/null > "$AUDIT_TEMP" || true

  # npm audit JSON structure: { "metadata": { "vulnerabilities": { "critical": N, ... } } }
  CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  HIGH=$(jq '.metadata.vulnerabilities.high // 0' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  LOW=$(jq '.metadata.vulnerabilities.low // 0' "$AUDIT_TEMP" 2>/dev/null || echo "0")

  VULNERABILITIES=$(jq '.metadata.vulnerabilities.total // 0' "$AUDIT_TEMP" 2>/dev/null || echo "0")
  BLOCKING_VULNS=$((CRITICAL + HIGH))

  PKG_MANAGER="npm"
fi

# Clean up temp file
rm -f "$AUDIT_TEMP"

# ============================================================================
# Report Results
# ============================================================================

if [ "$VULNERABILITIES" -eq 0 ]; then
  success "No security vulnerabilities detected"
  exit 0
fi

# Report vulnerabilities
echo ""
if [ "$BLOCKING_VULNS" -gt 0 ]; then
  error "Security vulnerabilities detected in production dependencies!"
else
  warning "Security vulnerabilities detected (non-blocking - low/moderate only)"
fi
echo ""

echo "ðŸ“Š Vulnerability Summary:"
echo "  Critical:  $CRITICAL"
echo "  High:      $HIGH"
echo "  Moderate:  $MODERATE"
echo "  Low:       $LOW"
echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "  Total:     $VULNERABILITIES"
echo ""

# Only block on high/critical vulnerabilities
if [ "$BLOCKING_VULNS" -gt 0 ]; then
  echo "ðŸ”§ Required Actions:"
  echo ""
  echo "1. REVIEW vulnerabilities in detail:"
  echo "   $PKG_MANAGER audit"
  echo ""
  echo "2. UPDATE dependencies to patched versions:"
  echo "   $PKG_MANAGER update"
  echo ""
  if [ "$PKG_MANAGER" = "npm" ]; then
    echo "3. IF NEEDED, try npm audit fix (may change APIs):"
    echo "   npm audit fix"
    echo ""
  fi
  echo "4. IF NO FIX AVAILABLE:"
  echo "   - Consult NPM/GitHub security advisory"
  echo "   - Wait for package maintainer to release patch"
  echo "   - Document why vulnerability is acceptable (if truly necessary)"
  echo ""
  echo "ðŸ“– More info: https://docs.npmjs.com/cli/v8/commands/npm-audit"
  echo ""
  exit 1
else
  # Low/moderate only - warn but don't block
  success "No high/critical vulnerabilities - continuing with commit"
  exit 0
fi
