#!/bin/sh

echo "ğŸš¨ Pre-commit checks starting..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check if CI or forced full test mode
if [ "$CI" = "true" ] || [ "$FULL_TEST" = "true" ]; then
  FULL_TEST_MODE=true
else
  FULL_TEST_MODE=false
fi

# ============================================================================
# EARLY EXIT: Docs-only commits skip all code checks
# ============================================================================

CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR || true)
CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$CODE_FILES" ]; then
  echo ""
  echo "ğŸ“š Docs-only commit detected"
  echo "âœ… Skipping code checks (docs-only commits bypass all checks)"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ… Pre-commit checks passed!"
  echo ""
  exit 0
fi

# ============================================================================
# PARALLEL EXECUTION: Run independent checks simultaneously
# ============================================================================

echo ""
echo "âš¡ Running independent security & quality checks in parallel..."
echo ""

# Create temp directory for log files
TEMP_DIR="/tmp/precommit-$$"
mkdir -p "$TEMP_DIR"
trap "rm -rf $TEMP_DIR" EXIT

# Start all parallel checks in background
bash .husky/pre-commit-secrets-scan > "$TEMP_DIR/secrets.log" 2>&1 & PID_SECRETS=$!
bash .husky/pre-commit-duplication-detection > "$TEMP_DIR/dup.log" 2>&1 & PID_DUP=$!
bash .husky/pre-commit-root-check > "$TEMP_DIR/root.log" 2>&1 & PID_ROOT=$!
bash .husky/pre-commit-dependencies-audit > "$TEMP_DIR/deps.log" 2>&1 & PID_DEPS=$!

# ESLint only on staged files to avoid blocking on pre-existing codebase errors
# Get staged files matching code extensions
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$STAGED_FILES" ]; then
  npx eslint $STAGED_FILES --ext .ts,.tsx,.js,.jsx > "$TEMP_DIR/lint.log" 2>&1 & PID_LINT=$!
else
  # No staged code files, skip linting
  echo "No staged code files to lint" > "$TEMP_DIR/lint.log"
  PID_LINT=""
  EXIT_CODE_LINT=0
fi

# Wait for all and collect exit codes
wait $PID_SECRETS 2>/dev/null; EXIT_CODE_SECRETS=$?
wait $PID_DUP 2>/dev/null; EXIT_CODE_DUP=$?
wait $PID_ROOT 2>/dev/null; EXIT_CODE_ROOT=$?
wait $PID_DEPS 2>/dev/null; EXIT_CODE_DEPS=$?
if [ -n "$PID_LINT" ]; then
  wait $PID_LINT 2>/dev/null; EXIT_CODE_LINT=$?
fi

# Check parallel results
PARALLEL_FAILED=0
FAILED_CHECKS=""

if [ $EXIT_CODE_SECRETS -ne 0 ]; then
  PARALLEL_FAILED=1
  FAILED_CHECKS="${FAILED_CHECKS}âŒ Secrets Scan
"
fi

if [ $EXIT_CODE_DUP -ne 0 ]; then
  PARALLEL_FAILED=1
  FAILED_CHECKS="${FAILED_CHECKS}âŒ Code Duplication
"
fi

if [ $EXIT_CODE_ROOT -ne 0 ]; then
  PARALLEL_FAILED=1
  FAILED_CHECKS="${FAILED_CHECKS}âŒ Root Directory Check
"
fi

if [ $EXIT_CODE_DEPS -ne 0 ]; then
  PARALLEL_FAILED=1
  FAILED_CHECKS="${FAILED_CHECKS}âŒ Dependency Audit
"
fi

if [ $EXIT_CODE_LINT -ne 0 ]; then
  PARALLEL_FAILED=1
  FAILED_CHECKS="${FAILED_CHECKS}âŒ ESLint
"
fi

# Report parallel check results
if [ $PARALLEL_FAILED -eq 1 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ Parallel checks failed:"
  echo "$FAILED_CHECKS"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  # Display detailed output from failed checks
  [ $EXIT_CODE_SECRETS -ne 0 ] && { echo "ğŸ“Œ Secrets Scan Details:"; cat "$TEMP_DIR/secrets.log"; echo ""; }
  [ $EXIT_CODE_DUP -ne 0 ] && { echo "ğŸ“Œ Code Duplication Details:"; cat "$TEMP_DIR/dup.log"; echo ""; }
  [ $EXIT_CODE_ROOT -ne 0 ] && { echo "ğŸ“Œ Root Directory Check Details:"; cat "$TEMP_DIR/root.log"; echo ""; }
  [ $EXIT_CODE_DEPS -ne 0 ] && { echo "ğŸ“Œ Dependency Audit Details:"; cat "$TEMP_DIR/deps.log"; echo ""; }
  [ $EXIT_CODE_LINT -ne 0 ] && { echo "ğŸ“Œ ESLint Details:"; cat "$TEMP_DIR/lint.log"; echo ""; }

  echo ""
  echo "Commit blocked by pre-commit hook."
  exit 1
else
  echo "âœ… All parallel checks passed"
fi

# ============================================================================
# SEQUENTIAL EXECUTION: Code Quality Checks (TypeScript, Tests)
# ============================================================================

echo ""
echo "ğŸ§ª Step 1/4: Skipping TypeScript type checking..."
echo "âš ï¸  TypeScript type checking is deferred to CI/CD pipeline (pnpm type-check in Jenkinsfile)"

echo ""
echo "ğŸ§ª Step 2/4: Checking for console statements..."

bash .husky/pre-commit-no-console > "$TEMP_DIR/console.log" 2>&1
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Console statement check failed!"
  echo ""
  cat "$TEMP_DIR/console.log"
  echo ""
  echo "Commit blocked by pre-commit hook."
  exit 1
else
  echo "âœ… Console statement check passed"
fi

echo ""
echo "ğŸ§ª Step 3/4: Checking for forbidden imports..."

bash .husky/pre-commit-forbidden-imports > "$TEMP_DIR/imports.log" 2>&1
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Forbidden imports check failed!"
  echo ""
  cat "$TEMP_DIR/imports.log"
  echo ""
  echo "Commit blocked by pre-commit hook."
  exit 1
else
  echo "âœ… Forbidden imports check passed"
fi

echo ""
echo "ğŸ§ª Step 4/4: Running unit tests..."

if [ "$FULL_TEST_MODE" = "true" ]; then
  echo "Running ALL unit tests (CI/FULL_TEST mode)..."
  npm test -- --passWithNoTests --ci --silent 2>&1 | tee "$TEMP_DIR/test-output.log"
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Unit tests failed!"
    echo ""
    echo "Please fix the failing tests before committing."
    echo ""
    echo "Commit blocked by pre-commit hook."
    exit 1
  else
    echo "âœ… All unit tests passed!"
  fi
else
  # Use curated fast unit tests for core services
  bash .husky/pre-commit-unit-tests > "$TEMP_DIR/unit-tests.log" 2>&1
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Core service unit tests failed!"
    echo ""
    cat "$TEMP_DIR/unit-tests.log"
    echo ""
    echo "Please fix the failing tests before committing."
    echo ""
    echo "To run ALL tests: FULL_TEST=true git commit ..."
    echo "To bypass tests (use with caution): git commit -n ..."
    echo ""
    echo "Commit blocked by pre-commit hook."
    exit 1
  else
    echo "âœ… Core service unit tests passed!"
    echo ""
    echo "â„¹ï¸  Running fast unit tests for core services only (ai-service, discussion-service, user-service)"
    echo "â„¹ï¸  To run ALL tests: FULL_TEST=true git commit ..."
  fi
fi

# ============================================================================
# FORMATTING: Lint-staged
# ============================================================================

echo ""
echo "ğŸ¨ Step 5/5: Running lint-staged for formatting..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Lint-staged checks failed!"
  echo ""
  echo "Commit blocked by pre-commit hook."
  exit 1
fi

# ============================================================================
# SUCCESS: All checks passed
# ============================================================================

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-commit checks passed! Proceeding with commit..."
echo ""
