#!/bin/bash

# ============================================================================
# Pre-Commit Hook: No Console Statements
# ============================================================================
# Prevents accidental console.log/debug/warn/error statements in production code
# Allows console statements in test files and allows console.error/warn in certain contexts
#
# Blocks: console.log, console.debug (in non-test files)
# Allows: console.error, console.warn (for warnings/errors)
# Allows: All console in __tests__, *.test.*, *.spec.* files
#
# Usage: Called automatically by git pre-commit hook
# Can be tested standalone: bash .husky/pre-commit-no-console
# ============================================================================

set -e

# Source color utilities
source "$(dirname -- "$0")/colors.sh"

echo ""
echo "ðŸš« Checking for unexpected console statements..."

# ============================================================================
# Get Staged Files
# ============================================================================

# Get list of staged code files (TypeScript, JavaScript)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  success "No code files to check"
  exit 0
fi

# ============================================================================
# Check for Console Statements
# ============================================================================

VIOLATIONS=()

while IFS= read -r file; do
  # Skip test files - console is allowed in tests
  if [[ "$file" =~ __tests__/ ]] || [[ "$file" =~ \.test\. ]] || [[ "$file" =~ \.spec\. ]]; then
    debug "Skipping test file: $file"
    continue
  fi

  # Skip main.ts files - startup messages are allowed
  if [[ "$file" =~ /main\.ts$ ]]; then
    debug "Skipping main.ts file: $file"
    continue
  fi

  # Skip seed files - console output is needed for database seeding status
  if [[ "$file" =~ seed\.(js|ts)$ ]] || [[ "$file" =~ /seeds/ ]]; then
    debug "Skipping seed file: $file"
    continue
  fi

  # Skip Playwright setup files - console output needed for CI/CD visibility
  if [[ "$file" =~ global-setup\.(js|ts)$ ]] || [[ "$file" =~ global-teardown\.(js|ts)$ ]]; then
    debug "Skipping Playwright setup file: $file"
    continue
  fi

  # Get staged content and check for problematic console statements
  STAGED_CONTENT=$(git show ":$file" 2>/dev/null || echo "")

  # Check for console.log
  if echo "$STAGED_CONTENT" | grep -E "console\.(log|debug)" | grep -v "^\s*\/\/" > /dev/null 2>&1; then
    VIOLATIONS+=("$file: contains console.log/debug")
  fi
done <<< "$STAGED_FILES"

# ============================================================================
# Report Results
# ============================================================================

if [ ${#VIOLATIONS[@]} -eq 0 ]; then
  success "No unexpected console statements detected"
  exit 0
fi

# Violations found
echo ""
error "Unexpected console statements detected!"
echo ""
echo "ðŸ“ Files with console statements:"

for violation in "${VIOLATIONS[@]}"; do
  warning "  $violation"
done

echo ""
echo "ðŸ”§ Required Actions:"
echo ""
echo "1. REMOVE console.log and console.debug statements:"
echo "   - These are typically for debugging and shouldn't be committed"
echo "   - Use a proper logger instead (e.g., Winston, Pino, debug module)"
echo ""
echo "2. ALLOWED console statements:"
echo "   - console.error(): for critical errors"
echo "   - console.warn(): for warnings"
echo "   - Any console in test files (__tests__/, *.test.*, *.spec.*)"
echo ""
echo "3. BETTER PRACTICES:"
echo "   - Use a logging library: npm install --save winston"
echo "   - Structured logging helps with debugging in production"
echo "   - Consider a debug module: npm install --save-dev debug"
echo ""
echo "4. STAGE your changes and commit again:"
echo "   git add ."
echo "   git commit -m 'your message'"
echo ""

exit 1
