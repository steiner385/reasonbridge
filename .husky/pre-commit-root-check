#!/bin/bash

# ============================================================================
# Pre-Commit Hook: Root Directory Organization Check
# ============================================================================
# Prevents accidental files/directories from being added to repository root
# Enforces clean project structure by whitelisting allowed root-level items
#
# Allowed root directories:
#   - src/, spec/, server/, prisma/, services/, packages/, tests/
#   - docs/, scripts/, deployment/, .github/, docker/
#
# Allowed root files:
#   - Configuration: *.json, *.yml, *.yaml, tsconfig*, vite*, jest*, webpack*
#   - Git: .gitignore, .gitattributes
#   - Docker: Dockerfile, docker-compose*.yml
#   - Other: README*, LICENSE*, .editorconfig, .husky/, .env*
# ============================================================================

set -e

# Source color utilities
source "$(dirname -- "$0")/colors.sh"

echo ""
echo "ðŸ“ Running root directory organization check..."

# ============================================================================
# Configuration
# ============================================================================

# Allowed directories at root level
ALLOWED_DIRS=(
  "^src/$"
  "^specs/$"
  "^spec/$"
  "^server/$"
  "^prisma/$"
  "^services/$"
  "^packages/$"
  "^tests/$"
  "^docs/$"
  "^scripts/$"
  "^deployment/$"
  "^\\.github/$"
  "^docker/$"
  "^\\.husky/$"
  "^node_modules/$"
  "^\\.venv/$"
  "^dist"
  "^coverage/$"
  "^\\.next/$"
)

# Allowed files at root level (patterns)
ALLOWED_FILES=(
  "^\\..*"                      # Hidden files/dirs
  "^README.*"                   # README files
  "^LICENSE.*"                  # License files
  "^package.*\\.json$"          # package.json, package-lock.json
  "^package.*\\.yaml$"          # package.yaml
  "^tsconfig.*\\.json$"         # TypeScript configs
  "^vite.*\\.config\\..*$"      # Vite configs
  "^jest.*\\.config\\..*$"      # Jest configs
  "^webpack.*\\.config\\..*$"   # Webpack configs
  "^playwright.*\\.config\\..*$" # Playwright configs
  "^prettier.*\\.config\\..*$"  # Prettier configs
  "^eslint.*\\.config\\..*$"    # ESLint configs
  "^\\.eslintrc.*$"             # ESLint rc files
  "^docker-compose.*\\.yml$"    # Docker compose
  "^Dockerfile$"                # Dockerfile
  "^docker-compose$"            # docker-compose executable
  "^\\.editorconfig$"           # EditorConfig
  "^Makefile$"                  # Makefile
  "^turbo\\.json$"              # Turbo config
  "^nx\\.json$"                 # NX config
  "^pnpm-workspace\\.yaml$"     # PNPM workspace
  "^pnpm-lock\\.yaml$"          # PNPM lockfile
  "^lerna\\.json$"              # Lerna config
  "^index\\.html$"              # Vite HTML template entry point
  "^CLAUDE\\.md$"               # Claude Code instructions
)

# ============================================================================
# Get Changed Files
# ============================================================================

# Get list of staged files (exclude deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null | grep -v "^$" || true)

if [ -z "$STAGED_FILES" ]; then
  success "No files to check"
  exit 0
fi

debug "Checking $(echo "$STAGED_FILES" | wc -l) staged files"

# ============================================================================
# Check for Root-Level Additions
# ============================================================================

VIOLATIONS=()

while IFS= read -r file; do
  # Skip files not at root level (have slash in path)
  if [[ "$file" == *"/"* ]]; then
    continue
  fi

  # File is at root level - check if it's allowed
  is_allowed=0

  # Check against allowed directories (files that are actually directories)
  for dir_pattern in "${ALLOWED_DIRS[@]}"; do
    if [[ "$file" =~ $dir_pattern ]]; then
      is_allowed=1
      break
    fi
  done

  # If not a directory, check against allowed files
  if [ $is_allowed -eq 0 ]; then
    for file_pattern in "${ALLOWED_FILES[@]}"; do
      if [[ "$file" =~ $file_pattern ]]; then
        is_allowed=1
        break
      fi
    done
  fi

  # Record violations
  if [ $is_allowed -eq 0 ]; then
    VIOLATIONS+=("$file")
  fi
done <<< "$STAGED_FILES"

# ============================================================================
# Report Results
# ============================================================================

if [ ${#VIOLATIONS[@]} -eq 0 ]; then
  success "Root directory organization check passed"
  exit 0
fi

# Violations found
echo ""
error "Root directory organization violation detected!"
echo ""
echo "ðŸ“ Unauthorized files/directories at root level:"

for violation in "${VIOLATIONS[@]}"; do
  warning "$violation"
done

echo ""
echo "ðŸ”§ Required Actions:"
echo ""
echo "ALLOWED at root level:"
echo "  Directories: src/, specs/, server/, prisma/, services/, packages/, tests/"
echo "               docs/, scripts/, deployment/, .github/, docker/"
echo ""
echo "  Files: Configuration files (package.json, tsconfig.json, etc.)"
echo "         Git files (.gitignore, .gitattributes)"
echo "         Docker files (Dockerfile, docker-compose.yml)"
echo "         Documentation (README.*, LICENSE.*)"
echo "         Build configs (vite, jest, webpack, prettier, eslint)"
echo ""
echo "NOT ALLOWED at root level:"
echo "  Random files or directories"
echo "  Utility directories (use src/lib/ or src/utils/)"
echo "  Temporary or build artifacts (use .gitignore)"
echo ""
echo "ðŸ’¡ Fix violations:"
echo ""
for violation in "${VIOLATIONS[@]}"; do
  if [ -d "$violation" ]; then
    echo "  Directory '$violation':"
    echo "    â†’ Move to appropriate location (e.g., src/$violation)"
  else
    echo "  File '$violation':"
    echo "    â†’ Check if it belongs in src/, docs/, scripts/, or should be added to whitelist"
  fi
done

echo ""
echo "ðŸ“– More info: See .husky/pre-commit-root-check to update whitelist"
echo ""

exit 1
