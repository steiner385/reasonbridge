#!/bin/sh

# ============================================================================
# Commit Message Hook: Conventional Commits Linting
# ============================================================================
# Enforces conventional commit format for consistent git history and
# automatic changelog generation
#
# Valid commit types:
#   feat:     A new feature
#   fix:      A bug fix
#   docs:     Documentation only changes
#   style:    Changes that don't affect code meaning (whitespace, formatting)
#   refactor: Code change that neither fixes a bug nor adds a feature
#   perf:     Code change that improves performance
#   test:     Adding missing tests or correcting existing tests
#   chore:    Changes to build process, deps, or tooling (no code change)
#   ci:       Changes to CI/CD configuration
#
# Format: type(scope?): subject
# Example: feat(auth): add JWT token refresh capability
#
# Usage: Called automatically after 'git commit -m' command
# ============================================================================

set -e

# Source color utilities (if available, but don't fail if not)
SCRIPT_DIR="$(dirname -- "$0")"
if [ -f "$SCRIPT_DIR/colors.sh" ]; then
  . "$SCRIPT_DIR/colors.sh"
else
  # Fallback if colors.sh is unavailable
  success() { echo "‚úÖ $1"; }
  error() { echo "‚ùå $1"; }
  warning() { echo "‚ö†Ô∏è  $1"; }
  info() { echo "‚Ñπ  $1"; }
fi

# ============================================================================
# Configuration
# ============================================================================

COMMIT_MSG_FILE="$1"
COMMIT_MESSAGE=$(cat "$COMMIT_MSG_FILE")

# Allowed commit types
VALID_TYPES="^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?: .+"

# ============================================================================
# Skip certain commits
# ============================================================================

# Skip merge commits
if echo "$COMMIT_MESSAGE" | grep -q "^Merge"; then
  exit 0
fi

# Skip squash/fixup commits
if echo "$COMMIT_MESSAGE" | grep -qE "^(squash|fixup)!"; then
  exit 0
fi

# ============================================================================
# Validate Commit Message Format
# ============================================================================

if ! echo "$COMMIT_MESSAGE" | grep -qE "$VALID_TYPES"; then
  echo ""
  error "Invalid commit message format!"
  echo ""
  echo "üìù Commit message must follow Conventional Commits format:"
  echo "   type(scope?): subject"
  echo ""
  echo "Examples:"
  echo "   feat(auth): add JWT token refresh"
  echo "   fix(api): resolve database connection timeout"
  echo "   docs: update README with new instructions"
  echo "   refactor(utils): extract duplicate logic"
  echo "   chore(deps): update dependencies"
  echo ""
  echo "üìå Valid commit types:"
  echo "   feat:     A new feature"
  echo "   fix:      A bug fix"
  echo "   docs:     Documentation changes"
  echo "   style:    Formatting (no logic change)"
  echo "   refactor: Refactoring (no feature or bug fix)"
  echo "   perf:     Performance improvement"
  echo "   test:     Adding/updating tests"
  echo "   chore:    Build, deps, tooling"
  echo "   ci:       CI/CD configuration"
  echo ""
  echo "üí° Scope is optional but recommended:"
  echo "   Use: feat(auth): ... or just feat: ..."
  echo ""
  echo "üìñ Learn more: https://www.conventionalcommits.org"
  echo ""

  exit 1
fi

success "Commit message format is valid!"
exit 0
