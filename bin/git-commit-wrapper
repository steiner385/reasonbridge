#!/bin/bash

# ============================================================================
# Git Commit Wrapper - Prevents bypassing pre-commit hooks
# ============================================================================
# This script prevents using --no-verify or -n flags which bypass critical
# quality gates and security checks.
#
# Usage: npm run commit -- [arguments]
# Examples:
#   npm run commit -- -m "feat: add new feature"
#   npm run commit -- -m "fix: resolve issue" --amend
#
# For full testing before release:
#   FULL_TEST=true npm run commit -- -m "message"
#
# ============================================================================

set -e

# Check for --no-verify or -n flags
if [[ "$@" == *"--no-verify"* ]] || [[ "$@" == *"-n"* ]]; then
  echo ""
  echo "âŒ ERROR: Using --no-verify or -n is not permitted in this repository"
  echo ""
  echo "Pre-commit hooks are MANDATORY quality gates that ensure:"
  echo "  âœ“ No secrets are committed (credentials, API keys, tokens)"
  echo "  âœ“ No code duplication issues"
  echo "  âœ“ TypeScript types are valid"
  echo "  âœ“ No console.log statements in production code"
  echo "  âœ“ No forbidden imports or anti-patterns"
  echo "  âœ“ Dependencies are secure (no known vulnerabilities)"
  echo "  âœ“ File sizes are reasonable"
  echo "  âœ“ Code is properly formatted"
  echo "  âœ“ Tests pass for changed code"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "ğŸ”§ What to do instead:"
  echo ""
  echo "1. READ the error message from the failing hook"
  echo "2. FIX the issue in your code"
  echo "3. STAGE the fixed changes"
  echo "4. COMMIT again (hooks will pass)"
  echo ""
  echo "Example workflow:"
  echo "  $ git add ."
  echo "  $ npm run commit -- -m 'feat: add feature'"
  echo "  âŒ Unit tests failed (example error)"
  echo "  $ npm test -- --testPathPattern=mytest.test.ts  # debug"
  echo "  $ git add ."
  echo "  $ npm run commit -- -m 'feat: add feature'  # try again"
  echo "  âœ… All checks passed!"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "âš™ï¸  Advanced options:"
  echo "  - For FULL test suite (before releases): FULL_TEST=true npm run commit -- -m 'message'"
  echo "  - To uninstall hooks (emergency only): npx husky uninstall"
  echo ""
  exit 1
fi

# Run the actual commit with all arguments
exec git commit "$@"
